(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Wolfram 14.2' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       154,          7]
NotebookDataLength[     33576,        907]
NotebookOptionsPosition[     33219,        893]
NotebookOutlinePosition[     33616,        909]
CellTagsIndexPosition[     33573,        906]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"--", 
      RowBox[{"-", "1."}]}], " ", "Define", " ", "Materials", " ", "and", " ",
      "Dispersive", " ", "Refractive", " ", 
     RowBox[{"Indices", "--"}]}], "-"}], "*)"}], 
  RowBox[{"(*", 
   RowBox[{
   "Using", " ", "Sellmeier", " ", "equations", " ", "or", " ", 
    "interpolated", " ", "data", " ", "for", " ", "realistic", " ", 
    "models"}], "*)"}], 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"n", 
     RowBox[{"(", "lambda", ")"}]}], "=", 
    RowBox[{"sqrt", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"1", "+", 
        RowBox[{"B1", "*", 
         RowBox[{
          RowBox[{"lambda", "^", "2"}], "/", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"lambda", "^", "2"}], "-", "C1"}], ")"}]}]}], "+"}], 
       "..."}], ")"}]}]}], "*)"}], 
  RowBox[{"(*", 
   RowBox[{
   "k", " ", "is", " ", "the", " ", "extinction", " ", "coefficient"}], 
   "*)"}], 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"nGlass", "[", "lambda_", "]"}], ":=", 
     RowBox[{"Sqrt", "[", 
      RowBox[{"1", "+", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"1.03961212", "*", 
          RowBox[{"lambda", "^", "2"}]}], ")"}], "/", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"lambda", "^", "2"}], "-", "0.00600069867"}], ")"}]}], "+", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"0.231792344", "*", 
          RowBox[{"lambda", "^", "2"}]}], ")"}], "/", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"lambda", "^", "2"}], "-", "0.0200179144"}], ")"}]}], "+", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"1.01046945", "*", 
          RowBox[{"lambda", "^", "2"}]}], ")"}], "/", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"lambda", "^", "2"}], "-", "103.560653"}], ")"}]}]}], 
      "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"kGlass", "[", "lambda_", "]"}], ":=", "0"}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Data", " ", "for", " ", "ITO"}], ",", "Al", ",", 
     RowBox[{
     "and", " ", "organics", " ", "would", " ", "be", " ", "imported", " ", 
      "from", " ", "literature", " ", "data", " ", "files"}]}], "*)"}], "\n", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"For", " ", "this", " ", "example"}], ",", 
     RowBox[{
      RowBox[{"we", "'"}], "ll", " ", "use", " ", "simplified", " ", "but", " ",
       "dispersive", " ", "models"}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"nITO", "[", "lambda_", "]"}], ":=", 
     RowBox[{"1.8", "+", 
      RowBox[{"20000", "/", 
       RowBox[{"lambda", "^", "2"}]}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"kITO", "[", "lambda_", "]"}], ":=", 
     RowBox[{"0.05", "*", 
      RowBox[{"Exp", "[", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"lambda", "-", "400"}], ")"}]}], "/", "100"}], "]"}]}]}], 
    ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"nNPB", "[", "lambda_", "]"}], ":=", 
     RowBox[{"1.75", "+", 
      RowBox[{"15000", "/", 
       RowBox[{"lambda", "^", "2"}]}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"kNPB", "[", "lambda_", "]"}], ":=", 
     RowBox[{"0.01", "*", 
      RowBox[{"Exp", "[", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"lambda", "-", "380"}], ")"}]}], "/", "50"}], "]"}]}]}], 
    ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"nCBP", "[", "lambda_", "]"}], ":=", 
     RowBox[{"1.7", "+", 
      RowBox[{"18000", "/", 
       RowBox[{"lambda", "^", "2"}]}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"kCBP", "[", "lambda_", "]"}], ":=", 
     RowBox[{"0.01", "*", 
      RowBox[{"Exp", "[", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"lambda", "-", "370"}], ")"}]}], "/", "40"}], "]"}]}]}], 
    ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"nTPBi", "[", "lambda_", "]"}], ":=", 
     RowBox[{"1.72", "+", 
      RowBox[{"16000", "/", 
       RowBox[{"lambda", "^", "2"}]}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"kTPBi", "[", "lambda_", "]"}], ":=", 
     RowBox[{"0.01", "*", 
      RowBox[{"Exp", "[", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"(", 
          RowBox[{"lambda", "-", "360"}], ")"}]}], "/", "45"}], "]"}]}]}], 
    ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"nLiF", "[", "lambda_", "]"}], ":=", "1.39"}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"kLiF", "[", "lambda_", "]"}], ":=", "0"}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"nAl", "[", "lambda_", "]"}], ":=", 
     RowBox[{"0.9", "+", 
      RowBox[{"0.1", "*", 
       RowBox[{"(", 
        RowBox[{"lambda", "/", "550"}], ")"}]}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"kAl", "[", "lambda_", "]"}], ":=", 
     RowBox[{"7.0", "-", 
      RowBox[{"1.0", "*", 
       RowBox[{"(", 
        RowBox[{"lambda", "/", "550"}], ")"}]}]}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"materials", "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\"\<Glass\>\"", "->", 
        RowBox[{"{", 
         RowBox[{"nGlass", ",", "kGlass"}], "}"}]}], ",", 
       RowBox[{"\"\<ITO\>\"", "->", 
        RowBox[{"{", 
         RowBox[{"nITO", ",", "kITO"}], "}"}]}], ",", 
       RowBox[{"\"\<NPB\>\"", "->", 
        RowBox[{"{", 
         RowBox[{"nNPB", ",", "kNPB"}], "}"}]}], ",", 
       RowBox[{"\"\<CBP\>\"", "->", 
        RowBox[{"{", 
         RowBox[{"nCBP", ",", "kCBP"}], "}"}]}], ",", 
       RowBox[{"\"\<TPBi\>\"", "->", 
        RowBox[{"{", 
         RowBox[{"nTPBi", ",", "kTPBi"}], "}"}]}], ",", 
       RowBox[{"\"\<LiF\>\"", "->", 
        RowBox[{"{", 
         RowBox[{"nLiF", ",", "kLiF"}], "}"}]}], ",", 
       RowBox[{"\"\<Al\>\"", "->", 
        RowBox[{"{", 
         RowBox[{"nAl", ",", "kAl"}], "}"}]}]}], "}"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"--", 
         RowBox[{"-", "2."}]}], " ", "Implement", " ", "Transfer", " ", 
        "Matrix", " ", "Method", " ", 
        RowBox[{"(", "TMM", ")"}]}], "&"}], " ", 
      RowBox[{"Green", "'"}], "s", " ", 
      RowBox[{"Function", "--"}]}], "-"}], "*)"}], "\[IndentingNewLine]", 
   "\n", 
   RowBox[{"(*", 
    RowBox[{
    "Function", " ", "to", " ", "calculate", " ", "reflection", " ", 
     "coefficient", " ", "for", " ", "a", " ", "multilayer", " ", "stack", " ",
      "with", " ", "memoization"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"GetReflection", "[", 
      RowBox[{"pol_String", ",", 
       RowBox[{"lambda_", "?", "NumericQ"}], ",", 
       RowBox[{"theta_", "?", "NumericQ"}], ",", "thicknesses_List"}], "]"}], 
     ":=", 
     RowBox[{
      RowBox[{"GetReflection", "[", 
       RowBox[{"pol", ",", "lambda", ",", "theta", ",", "thicknesses"}], 
       "]"}], "=", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "nList", ",", "dList", ",", "k0", ",", "kx", ",", "kz", ",", "M", ",",
           "r"}], "}"}], ",", 
        RowBox[{
         RowBox[{"nList", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "[", "lambda", "]"}], "+", 
              RowBox[{"I", " ", 
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", "2", "]"}], "]"}], "[", "lambda", "]"}]}]}], 
             ")"}], "&"}], "/@", 
           RowBox[{"Values", "[", "materials", "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"dList", "=", 
          RowBox[{"Prepend", "[", 
           RowBox[{"thicknesses", ",", "Infinity"}], "]"}]}], ";", 
         RowBox[{"(*", 
          RowBox[{"Add", " ", "substrate"}], "*)"}], 
         RowBox[{"k0", "=", 
          RowBox[{"2", " ", 
           RowBox[{"Pi", "/", "lambda"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"kx", "=", 
          RowBox[{
           RowBox[{"nList", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "*", "k0", "*", 
           RowBox[{"Sin", "[", "theta", "]"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"kz", "=", 
          RowBox[{"Sqrt", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"nList", "^", "2"}], "*", 
             RowBox[{"k0", "^", "2"}]}], "-", 
            RowBox[{"kx", "^", "2"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", "Admittance", "*)"}], 
         RowBox[{
          RowBox[{"gamma", "[", "j_", "]"}], ":=", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"pol", "==", "\"\<s\>\""}], ",", 
            RowBox[{
             RowBox[{"kz", "[", 
              RowBox[{"[", "j", "]"}], "]"}], "/", 
             RowBox[{"(", "k0", ")"}]}], ",", 
            RowBox[{
             RowBox[{
              RowBox[{"nList", "[", 
               RowBox[{"[", "j", "]"}], "]"}], "^", "2"}], "*", 
             RowBox[{"k0", "/", 
              RowBox[{"kz", "[", 
               RowBox[{"[", "j", "]"}], "]"}]}]}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "Transfer", " ", "Matrix", " ", "for", " ", "a", " ", "single", " ",
            "layer"}], "*)"}], 
         RowBox[{
          RowBox[{"layerMatrix", "[", "j_", "]"}], ":=", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Cos", "[", 
               RowBox[{
                RowBox[{"kz", "[", 
                 RowBox[{"[", "j", "]"}], "]"}], " ", 
                RowBox[{"dList", "[", 
                 RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
              RowBox[{
               RowBox[{"I", "/", 
                RowBox[{"gamma", "[", "j", "]"}]}], " ", 
               RowBox[{"Sin", "[", 
                RowBox[{
                 RowBox[{"kz", "[", 
                  RowBox[{"[", "j", "]"}], "]"}], " ", 
                 RowBox[{"dList", "[", 
                  RowBox[{"[", "j", "]"}], "]"}]}], "]"}]}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"I", " ", 
               RowBox[{"gamma", "[", "j", "]"}], " ", 
               RowBox[{"Sin", "[", 
                RowBox[{
                 RowBox[{"kz", "[", 
                  RowBox[{"[", "j", "]"}], "]"}], " ", 
                 RowBox[{"dList", "[", 
                  RowBox[{"[", "j", "]"}], "]"}]}], "]"}]}], ",", 
              RowBox[{"Cos", "[", 
               RowBox[{
                RowBox[{"kz", "[", 
                 RowBox[{"[", "j", "]"}], "]"}], " ", 
                RowBox[{"dList", "[", 
                 RowBox[{"[", "j", "]"}], "]"}]}], "]"}]}], "}"}]}], "}"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
           "Total", " ", "Matrix", " ", "for", " ", "stack", " ", "from", " ",
             "layer", " ", "2", " ", "to", " ", "N"}], "-", "1"}], "*)"}], 
         RowBox[{"M", "=", 
          RowBox[{"Fold", "[", 
           RowBox[{"Dot", ",", 
            RowBox[{"IdentityMatrix", "[", "2", "]"}], ",", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"layerMatrix", "[", "j", "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "2", ",", 
                RowBox[{
                 RowBox[{"Length", "[", "nList", "]"}], "-", "1"}]}], "}"}]}],
              "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"Calculate", " ", "reflection", " ", "coefficient"}], 
          "*)"}], 
         RowBox[{"r", "=", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"M", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", "1"}], "]"}], "]"}], "+", 
                RowBox[{
                 RowBox[{"M", "[", 
                  RowBox[{"[", 
                   RowBox[{"1", ",", "2"}], "]"}], "]"}], " ", 
                 RowBox[{"gamma", "[", 
                  RowBox[{"Length", "[", "nList", "]"}], "]"}]}]}], ")"}], " ", 
              RowBox[{"gamma", "[", "1", "]"}]}], "-", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"M", "[", 
                RowBox[{"[", 
                 RowBox[{"2", ",", "1"}], "]"}], "]"}], "+", 
               RowBox[{
                RowBox[{"M", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", "2"}], "]"}], "]"}], " ", 
                RowBox[{"gamma", "[", 
                 RowBox[{"Length", "[", "nList", "]"}], "]"}]}]}], ")"}]}], 
            ")"}], "/", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"M", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", "1"}], "]"}], "]"}], "+", 
                RowBox[{
                 RowBox[{"M", "[", 
                  RowBox[{"[", 
                   RowBox[{"1", ",", "2"}], "]"}], "]"}], " ", 
                 RowBox[{"gamma", "[", 
                  RowBox[{"Length", "[", "nList", "]"}], "]"}]}]}], ")"}], " ", 
              RowBox[{"gamma", "[", "1", "]"}]}], "+", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"M", "[", 
                RowBox[{"[", 
                 RowBox[{"2", ",", "1"}], "]"}], "]"}], "+", 
               RowBox[{
                RowBox[{"M", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", "2"}], "]"}], "]"}], " ", 
                RowBox[{"gamma", "[", 
                 RowBox[{"Length", "[", "nList", "]"}], "]"}]}]}], ")"}]}], 
            ")"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Abs", "[", "r", "]"}], "^", "2"}]}]}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Simplified", " ", 
     RowBox[{"Green", "'"}], "s", " ", "function", " ", 
     RowBox[{"model", ":", 
      RowBox[{
       RowBox[{"Power", " ", "is", " ", "proportional", " ", "to", " ", "1"}],
        "-", "R"}]}]}], "*)"}], "\n", 
   RowBox[{"(*", 
    RowBox[{
    "We", " ", "calculate", " ", "power", " ", "radiated", " ", "into", " ", 
     "the", " ", "substrate", " ", 
     RowBox[{"vs", ".", "lost"}], " ", "to", " ", "the", " ", "metal"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"CalculatePowerDistribution", "[", 
      RowBox[{
       RowBox[{"lambda_", "?", "NumericQ"}], ",", "thicknesses_List"}], "]"}],
      ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"thetaCrit", ",", "pRad", ",", "pLoss"}], "}"}], ",", 
       RowBox[{
        RowBox[{"thetaCrit", "=", 
         RowBox[{"ArcSin", "[", 
          RowBox[{"1.0", "/", 
           RowBox[{"nGlass", "[", "lambda", "]"}]}], "]"}]}], ";", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{"Air", "/", "Glass"}], " ", "interface"}], "*)"}], 
        RowBox[{"(*", 
         RowBox[{"Radiated", " ", 
          RowBox[{"Power", ":", 
           RowBox[{
           "Integrated", " ", "over", " ", "the", " ", "escape", " ", 
            "cone"}]}]}], "*)"}], 
        RowBox[{"pRad", "=", 
         RowBox[{"NIntegrate", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "-", 
              RowBox[{"GetReflection", "[", 
               
               RowBox[{"\"\<s\>\"", ",", "lambda", ",", "theta", ",", 
                "thicknesses"}], "]"}]}], ")"}], "+", 
            RowBox[{"(", 
             RowBox[{"1", "-", 
              RowBox[{"GetReflection", "[", 
               
               RowBox[{"\"\<p\>\"", ",", "lambda", ",", "theta", ",", 
                "thicknesses"}], "]"}]}], ")"}]}], ",", 
           RowBox[{"{", 
            RowBox[{"theta", ",", "0", ",", "thetaCrit"}], "}"}]}], "]"}]}], ";",
         "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"Lost", " ", 
          RowBox[{"Power", ":", 
           RowBox[{"Waveguided", " ", "and", " ", "SPP", " ", "modes", " ", 
            RowBox[{"(", "approximated", ")"}]}]}]}], "*)"}], 
        RowBox[{"pLoss", "=", 
         RowBox[{"NIntegrate", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"GetReflection", "[", 
              
              RowBox[{"\"\<s\>\"", ",", "lambda", ",", "theta", ",", 
               "thicknesses"}], "]"}], ")"}], "+", 
            RowBox[{"(", 
             RowBox[{"GetReflection", "[", 
              
              RowBox[{"\"\<p\>\"", ",", "lambda", ",", "theta", ",", 
               "thicknesses"}], "]"}], ")"}]}], ",", 
           RowBox[{"{", 
            RowBox[{"theta", ",", "thetaCrit", ",", 
             RowBox[{"Pi", "/", "2"}]}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"pRad", ",", "pLoss"}], "}"}]}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{
    "Outcoupling", " ", "efficiency", " ", "at", " ", "a", " ", "given", " ", 
     "wavelength", " ", "with", " ", "memoization"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"etaOut", "[", 
      RowBox[{
       RowBox[{"lambda_", "?", "NumericQ"}], ",", "thicknesses_List"}], "]"}],
      ":=", 
     RowBox[{
      RowBox[{"etaOut", "[", 
       RowBox[{"lambda", ",", "thicknesses"}], "]"}], "=", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", "powers", "}"}], ",", 
        RowBox[{"(*", 
         RowBox[{
         "Check", " ", "if", " ", "the", " ", "denominator", " ", "is", " ", 
          "zero", " ", "before", " ", "division"}], "*)"}], 
        RowBox[{
         RowBox[{"powers", "=", 
          RowBox[{"CalculatePowerDistribution", "[", 
           RowBox[{"lambda", ",", "thicknesses"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Total", "[", "powers", "]"}], "==", "0"}], ",", "0", ",", 
           RowBox[{
            RowBox[{"First", "[", "powers", "]"}], "/", 
            RowBox[{"Total", "[", "powers", "]"}]}]}], "]"}]}]}], "]"}]}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"--", 
         RowBox[{"-", "3."}]}], " ", "Define", " ", "Optimization", " ", 
        "Goals"}], "&"}], " ", "Objective", " ", 
      RowBox[{"Function", "--"}]}], "-"}], "*)"}], "\[IndentingNewLine]", 
   "\n", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Emitter", "'"}], "s", " ", "intrinsic", " ", "spectrum"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"emissionSpectrum", "[", "lambda_", "]"}], ":=", 
     RowBox[{"Exp", "[", 
      RowBox[{"-", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"lambda", "-", "550"}], ")"}], "/", "100"}], ")"}], "^", 
        "2"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Goal", " ", "1"}], ":", 
     RowBox[{"Overall", " ", "Outcoupling", " ", "Efficiency"}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OverallEfficiency", "[", 
      RowBox[{"thicknesses_", "?", "VectorQ"}], "]"}], ":=", 
     RowBox[{
      RowBox[{"NIntegrate", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"etaOut", "[", 
          RowBox[{"lambda", ",", "thicknesses"}], "]"}], "*", 
         RowBox[{"emissionSpectrum", "[", "lambda", "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"lambda", ",", "400", ",", "700"}], "}"}], ",", 
        RowBox[{"Method", "->", "\"\<LocalAdaptive\>\""}]}], "]"}], "/", 
      RowBox[{"NIntegrate", "[", 
       RowBox[{
        RowBox[{"emissionSpectrum", "[", "lambda", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"lambda", ",", "400", ",", "700"}], "}"}]}], "]"}]}]}], 
    ";"}], "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Goal", " ", "2"}], ":", 
     RowBox[{"Outcoupling", " ", "Uniformity"}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Uniformity", "[", 
      RowBox[{"thicknesses_", "?", "VectorQ"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"etaValues", ",", "mean", ",", "stddev"}], "}"}], ",", 
       RowBox[{
        RowBox[{"etaValues", "=", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"etaOut", "[", 
            RowBox[{"lambda", ",", "thicknesses"}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"lambda", ",", "450", ",", "650", ",", "20"}], "}"}]}], 
          "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"mean", "=", 
         RowBox[{"Mean", "[", "etaValues", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"stddev", "=", 
         RowBox[{"StandardDeviation", "[", "etaValues", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"mean", "==", "0"}], ",", "0", ",", 
          RowBox[{"1", "-", 
           RowBox[{"stddev", "/", "mean"}]}]}], "]"}]}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{"Weights", " ", "for", " ", "each", " ", "objective"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"wEfficiency", "=", "0.7"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"wUniformity", "=", "0.3"}], ";"}], "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Combined", " ", "Objective", " ", "Function"}], "-", 
     RowBox[{
     "Takes", " ", "a", " ", "single", " ", "list", " ", "of", " ", 
      "thicknesses"}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"ObjectiveFunction", "[", 
      RowBox[{"thicknesses_", "?", "VectorQ"}], "]"}], ":=", 
     RowBox[{
      RowBox[{"wEfficiency", "*", 
       RowBox[{"OverallEfficiency", "[", "thicknesses", "]"}]}], "+", 
      RowBox[{"wUniformity", "*", 
       RowBox[{"Uniformity", "[", "thicknesses", "]"}]}]}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"--", 
       RowBox[{"-", "4."}]}], " ", "Perform", " ", "Multi"}], "-", 
     RowBox[{"Objective", " ", 
      RowBox[{"Optimization", "--"}]}], "-"}], "*)"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
    "Print", "[", "\"\<Starting optimization... This may take several \
minutes.\>\"", "]"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"optimizationResult", "=", 
     RowBox[{"NMaximize", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"ObjectiveFunction", "[", 
          RowBox[{"{", 
           RowBox[{
           "d_ito", ",", "d_npb", ",", "d_cbp", ",", "d_tpbi", ",", "d_lif", ",",
             "Infinity"}], "}"}], "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{
          "Constraints", " ", "for", " ", "layer", " ", "thicknesses", " ", 
           "in", " ", "nm"}], "*)"}], 
         RowBox[{
          RowBox[{"140", "<", "d_ito", "<", "160"}], "&&", 
          RowBox[{"80", "<", "d_npb", "<", "100"}], "&&", 
          RowBox[{"15", "<", "d_cbp", "<", "25"}], "&&", 
          RowBox[{"35", "<", "d_tpbi", "<", "45"}], "&&", 
          RowBox[{"0.5", "<", "d_lif", "<", "1.5"}]}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "d_ito", ",", "d_npb", ",", "d_cbp", ",", "d_tpbi", ",", "d_lif"}], 
        "}"}], ",", 
       RowBox[{"Method", "->", "\"\<DifferentialEvolution\>\""}], ",", 
       RowBox[{"(*", 
        RowBox[{
        "Good", " ", "for", " ", "complex", " ", "global", " ", 
         "optimization"}], "*)"}], 
       RowBox[{"MaxIterations", "->", "50"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"--", 
       RowBox[{"-", "5."}]}], " ", "Visualize", " ", "and", " ", "Report", " ", 
      RowBox[{"Results", "--"}]}], "-"}], "*)"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Print", "[", "\"\<\\n--- Optimization Complete ---\>\"", "]"}], 
    ";"}], "\n", 
   RowBox[{
    RowBox[{"Print", "[", 
     RowBox[{"\"\<Maximized Objective Value: \>\"", ",", 
      RowBox[{"optimizationResult", "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"Print", "[", "\"\<Optimal Thicknesses (nm):\>\"", "]"}], ";"}], "\n", 
   RowBox[{"TableForm", "[", 
    RowBox[{
     RowBox[{"List", "@@@", 
      RowBox[{"optimizationResult", "[", 
       RowBox[{"[", "2", "]"}], "]"}]}], ",", 
     RowBox[{"TableHeadings", "->", 
      RowBox[{"{", 
       RowBox[{"None", ",", 
        RowBox[{"{", 
         RowBox[{"\"\<Layer\>\"", ",", "\"\<Thickness (nm)\>\""}], "}"}]}], 
       "}"}]}]}], "]"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"optimizedThicknesses", "=", 
     RowBox[{"Values", "[", 
      RowBox[{"optimizationResult", "[", 
       RowBox[{"[", "2", "]"}], "]"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"finalThicknesses", "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"optimizedThicknesses", "[", 
        RowBox[{"[", "1", "]"}], "]"}], ",", 
       RowBox[{"optimizedThicknesses", "[", 
        RowBox[{"[", "2", "]"}], "]"}], ",", 
       RowBox[{"optimizedThicknesses", "[", 
        RowBox[{"[", "3", "]"}], "]"}], ",", 
       RowBox[{"optimizedThicknesses", "[", 
        RowBox[{"[", "4", "]"}], "]"}], ",", 
       RowBox[{"optimizedThicknesses", "[", 
        RowBox[{"[", "5", "]"}], "]"}], ",", "Infinity"}], "}"}]}], ";"}], 
   "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{"Final", " ", "calculated", " ", "metrics"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"finalEta", "=", 
     RowBox[{"OverallEfficiency", "[", "finalThicknesses", "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"finalU", "=", 
     RowBox[{"Uniformity", "[", "finalThicknesses", "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"Print", "[", 
     RowBox[{"\"\<\\nOverall Outcoupling Efficiency: \>\"", ",", 
      RowBox[{"NumberForm", "[", 
       RowBox[{"finalEta", ",", 
        RowBox[{"{", 
         RowBox[{"3", ",", "3"}], "}"}]}], "]"}]}], "]"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"Print", "[", 
     RowBox[{"\"\<Outcoupling Uniformity Score: \>\"", ",", 
      RowBox[{"NumberForm", "[", 
       RowBox[{"finalU", ",", 
        RowBox[{"{", 
         RowBox[{"3", ",", "3"}], "}"}]}], "]"}]}], "]"}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{
    "Plot", " ", "the", " ", "optimized", " ", "outcoupling", " ", 
     "efficiency", " ", "spectrum"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"etaPlot", "=", 
     RowBox[{"Plot", "[", 
      RowBox[{
       RowBox[{"etaOut", "[", 
        RowBox[{"lambda", ",", "finalThicknesses"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"lambda", ",", "400", ",", "700"}], "}"}], ",", 
       RowBox[{"PlotRange", "->", 
        RowBox[{"{", 
         RowBox[{"0", ",", "Automatic"}], "}"}]}], ",", 
       RowBox[{"AxesLabel", "->", 
        RowBox[{"{", 
         RowBox[{"\"\<Wavelength (nm)\>\"", 
          ",", "\"\<Outcoupling Efficiency\>\""}], "}"}]}], ",", 
       RowBox[{
       "PlotLabel", 
        "->", "\"\<Optimized Outcoupling (Blue) vs. Emitter Spectrum (Orange)\
\>\""}], ",", 
       RowBox[{"GridLines", "->", "Automatic"}], ",", 
       RowBox[{"PlotStyle", "->", 
        RowBox[{"{", 
         RowBox[{"Thick", ",", "Blue"}], "}"}]}], ",", 
       RowBox[{"ImageSize", "->", "Large"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{
    "Plot", " ", "the", " ", "emitter", " ", "spectrum", " ", "for", " ", 
     "reference"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"emitterPlot", "=", 
     RowBox[{"Plot", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Max", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"etaOut", "[", 
            RowBox[{"#", ",", "finalThicknesses"}], "]"}], "&"}], "/@", 
          RowBox[{"Range", "[", 
           RowBox[{"400", ",", "700"}], "]"}]}], "]"}], "*", 
        RowBox[{"emissionSpectrum", "[", "lambda", "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"lambda", ",", "400", ",", "700"}], "}"}], ",", 
       RowBox[{"PlotStyle", "->", 
        RowBox[{"{", 
         RowBox[{"Dashed", ",", "Orange"}], "}"}]}]}], "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{"Show", "[", 
    RowBox[{"etaPlot", ",", "emitterPlot"}], "]"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"--", 
       RowBox[{"-", "6."}]}], " ", "Angular", " ", "Dependence", " ", 
      RowBox[{"Plot", "--"}]}], "-"}], "*)"}], "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{
    "Function", " ", "to", " ", "calculate", " ", "angular", " ", "intensity",
      " ", "for", " ", "a", " ", "given", " ", "wavelength"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"AngularIntensity", "[", 
      RowBox[{
       RowBox[{"lambda_", "?", "NumericQ"}], ",", 
       RowBox[{"theta_", "?", "NumericQ"}], ",", "thicknesses_List"}], "]"}], 
     ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"r_s", ",", "r_p"}], "}"}], ",", 
       RowBox[{
        RowBox[{"r_s", "=", 
         RowBox[{"GetReflection", "[", 
          
          RowBox[{"\"\<s\>\"", ",", "lambda", ",", "theta", ",", 
           "thicknesses"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"r_p", "=", 
         RowBox[{"GetReflection", "[", 
          
          RowBox[{"\"\<p\>\"", ",", "lambda", ",", "theta", ",", 
           "thicknesses"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "Average", " ", "of", " ", "s", " ", "and", " ", "p", " ", 
          "polarization", " ", "transmission"}], "*)"}], 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"1", "-", "r_s"}], ")"}], "+", 
           RowBox[{"(", 
            RowBox[{"1", "-", "r_p"}], ")"}]}], ")"}], "/", "2"}]}]}], 
      "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
    "Print", "[", "\"\<\\nGenerating Angular Dependence Plot...\>\"", "]"}], 
    ";"}], "\n", 
   RowBox[{"angularPlot", "=", 
    RowBox[{"Plot", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"AngularIntensity", "[", 
         RowBox[{"460", ",", 
          RowBox[{"theta", " ", "Degree"}], ",", "finalThicknesses"}], "]"}], 
        ",", 
        RowBox[{"AngularIntensity", "[", 
         RowBox[{"540", ",", 
          RowBox[{"theta", " ", "Degree"}], ",", "finalThicknesses"}], "]"}], 
        ",", 
        RowBox[{"AngularIntensity", "[", 
         RowBox[{"620", ",", 
          RowBox[{"theta", " ", "Degree"}], ",", "finalThicknesses"}], 
         "]"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"theta", ",", "0", ",", "90"}], "}"}], ",", 
      RowBox[{"PlotRange", "->", "All"}], ",", 
      RowBox[{"PlotLegends", "->", 
       RowBox[{"{", 
        RowBox[{"\"\<460 nm (Blue)\>\"", ",", "\"\<540 nm (Green)\>\"", 
         ",", "\"\<620 nm (Red)\>\""}], "}"}]}], ",", 
      RowBox[{"AxesLabel", "->", 
       RowBox[{"{", 
        RowBox[{"\"\<Angle from Normal (\[Degree])\>\"", 
         ",", "\"\<Relative Intensity\>\""}], "}"}]}], ",", 
      RowBox[{
      "PlotLabel", "->", "\"\<Angular Dependent Outcoupling Intensity\>\""}], 
      ",", 
      RowBox[{"GridLines", "->", "Automatic"}], ",", 
      RowBox[{"PlotStyle", "->", 
       RowBox[{"{", 
        RowBox[{"Thick", ",", 
         RowBox[{"{", 
          RowBox[{"Blue", ",", "Green", ",", "Red"}], "}"}]}], "}"}]}], ",", 
      RowBox[{"ImageSize", "->", "Large"}]}], "]"}]}], "\n"}]}]], "Input",
 CellChangeTimes->{{3.962960065466425*^9, 
  3.962960065466425*^9}},ExpressionUUID->"ec9ab93d-9f5b-1e41-8465-\
c3191fd5c115"]
},
WindowSize->{949, 557},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
FrontEndVersion->"14.2 for Microsoft Windows (64-bit) (March 14, 2025)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"cb1c245e-ded5-554e-a8b7-331dd1d4c95e"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[554, 20, 32661, 871, 2920, "Input",ExpressionUUID->"ec9ab93d-9f5b-1e41-8465-c3191fd5c115"]
}
]
*)

(* End of internal cache information *)

